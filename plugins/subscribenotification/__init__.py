import random
from datetime import datetime, timedelta

import pytz
from app.chain.media import MediaChain
from app.chain.tmdb import TmdbChain
from app.core.config import settings
from app.db.subscribe_oper import SubscribeOper
from app.plugins import _PluginBase
from typing import Any, List, Dict, Tuple, Optional
from app.log import logger
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger
from app.schemas import NotificationType, MediaType


class SubscribeNotification(_PluginBase):
    # Êèí‰ª∂ÂêçÁß∞
    plugin_name = "ÊèêÈÜíËÆ¢ÈòÖ"
    # Êèí‰ª∂ÊèèËø∞
    plugin_desc = "Êé®ÈÄÅÂΩìÂ§©ËÆ¢ÈòÖÊõ¥Êñ∞ÂÜÖÂÆπ„ÄÇ"
    # Êèí‰ª∂ÂõæÊ†á
    plugin_icon = "https://raw.githubusercontent.com/jianxcao/MoviePilot-extension/main/img/sub-alert.png"
    # Êèí‰ª∂ÁâàÊú¨
    plugin_version = "1.2"
    # Êèí‰ª∂‰ΩúËÄÖ
    plugin_author = "jianxcao,thsrite"
    # Âä†ËΩΩÈ°∫Â∫è
    plugin_order = 33
    # ÂèØ‰ΩøÁî®ÁöÑÁî®Êà∑Á∫ßÂà´
    auth_level = 1

    # ÁßÅÊúâÂ±ûÊÄß
    _enabled: bool = False
    _onlyonce: bool = False
    _time = None
    _img_link = ''
    tmdb = None
    media = None
    subscribe_oper = None
    _scheduler: Optional[BackgroundScheduler] = None

    def init_plugin(self, config: dict = None):
        self.subscribe_oper = SubscribeOper()
        self.tmdb = TmdbChain()
        self.media = MediaChain()

        # ÂÅúÊ≠¢Áé∞Êúâ‰ªªÂä°
        self.stop_service()

        if config:
            self._enabled = config.get("enabled")
            self._onlyonce = config.get("onlyonce")
            self._time = config.get("time")
            self._img_link = config.get('img_link')

            if self._enabled or self._onlyonce:
                # Âë®ÊúüËøêË°å
                self._scheduler = BackgroundScheduler(timezone=settings.TZ)

                if self._time and str(self._time).isdigit():
                    cron = f"0 {int(self._time)} * * *"
                    try:
                        self._scheduler.add_job(func=self.__send_notify,
                                                trigger=CronTrigger.from_crontab(
                                                    cron),
                                                name="ËÆ¢ÈòÖÊèêÈÜí")
                    except Exception as err:
                        logger.error(f"ÂÆöÊó∂‰ªªÂä°ÈÖçÁΩÆÈîôËØØÔºö{err}")
                        # Êé®ÈÄÅÂÆûÊó∂Ê∂àÊÅØ
                        self.systemmessage.put(f"ÊâßË°åÂë®ÊúüÈÖçÁΩÆÈîôËØØÔºö{err}")

                # Á´ãÂç≥ËøêË°å‰∏ÄÊ¨°
                if self._onlyonce:
                    logger.info(f"ËÆ¢ÈòÖÊèêÈÜíÊúçÂä°ÂêØÂä®ÔºåÁ´ãÂç≥ËøêË°å‰∏ÄÊ¨°")
                    self._scheduler.add_job(self.__send_notify, 'date',
                                            run_date=datetime.now(
                                                tz=pytz.timezone(settings.TZ)) + timedelta(seconds=3),
                                            name="ËÆ¢ÈòÖÊèêÈÜí")
                    # ÂÖ≥Èó≠‰∏ÄÊ¨°ÊÄßÂºÄÂÖ≥
                    self._onlyonce = False

                    # ‰øùÂ≠òÈÖçÁΩÆ
                    self.__update_config()

                # ÂêØÂä®‰ªªÂä°
                if self._scheduler.get_jobs():
                    self._scheduler.print_jobs()
                    self._scheduler.start()

    def __update_config(self):
        self.update_config({
            "enabled": self._enabled,
            "onlyonce": self._onlyonce,
            "time": self._time,
            "img_link": self._img_link
        })

    def __send_notify(self):
        # Êü•ËØ¢ÊâÄÊúâËÆ¢ÈòÖ
        subscribes = self.subscribe_oper.list()
        if not subscribes:
            logger.error("ÂΩìÂâçÊ≤°ÊúâËÆ¢ÈòÖÔºåË∑≥ËøáÂ§ÑÁêÜ")
            return

        # ÂΩìÂâçÊó•Êúü
        current_date = datetime.now().date().strftime("%Y-%m-%d")

        current_tv_subscribe = []
        current_movie_subscribe = []
        imgs = []
        img_url = "https://raw.githubusercontent.com/jianxcao/MoviePilot-extension/main/img/default.png"
        # ÈÅçÂéÜËÆ¢ÈòÖÔºåÊü•ËØ¢tmdb
        for subscribe in subscribes:
            # ÁîµËßÜÂâß
            if subscribe.type == "ÁîµËßÜÂâß":
                if not subscribe.tmdbid or not subscribe.season:
                    continue

                # ÁîµËßÜÂâßÊüêÂ≠£ÊâÄÊúâÈõÜ
                episodes_info = self.tmdb.tmdb_episodes(
                    tmdbid=subscribe.tmdbid, season=subscribe.season)
                if not episodes_info:
                    continue

                episodes = []
                # ÈÅçÂéÜÈõÜÔºåÁ≠õÈÄâÂΩìÂâçÊó•ÊúüÂèëÂ∏ÉÁöÑÂâßÈõÜ
                for episode in episodes_info:
                    if episode and episode.air_date and str(episode.air_date) == current_date:
                        episodes.append(episode.episode_number)

                if episodes:
                    if isinstance(subscribe.backdrop, str) and subscribe.backdrop != "":
                        imgs.append(subscribe.backdrop)
                    elif isinstance(subscribe.poster, str) and subscribe.poster != "":
                        imgs.append(subscribe.poster)
                    current_tv_subscribe.append({
                        'name': f"üì∫ {subscribe.name}",
                        'season': f"Á¨¨{str(subscribe.season).rjust(2, '0')}Â≠£",
                        'episode': f"Á¨¨{str(episodes[0]).rjust(2, '0')}-{str(episodes[-1]).rjust(2, '0')}ÈõÜ" if len(
                            episodes) > 1 else f"Á¨¨{str(episodes[0]).rjust(2, '0')}ÈõÜ"
                    })

            # ÁîµÂΩ±
            else:
                if not subscribe.tmdbid:
                    continue
                mediainfo = self.media.recognize_media(
                    tmdbid=subscribe.tmdbid, mtype=MediaType.MOVIE)
                if not mediainfo:
                    continue
                if str(mediainfo.release_date) == current_date:
                    if isinstance(subscribe.backdrop, str) and subscribe.backdrop != "":
                        imgs.append(subscribe.backdrop)
                    elif isinstance(subscribe.poster, str) and subscribe.poster != "":
                        imgs.append(subscribe.poster)
                    current_movie_subscribe.append({
                        'name': f"üé¨ {subscribe.name} ({subscribe.year})"
                    })
        if len(imgs):
            img_url = random.choice(imgs)

        if isinstance(self._img_link, str) and len(self._img_link) > 0:
            links = list(filter(lambda url: url.startswith(
                "http"), self._img_link.split("\n")))
            if len(links) > 0:
                img_url = random.choice(links)
        # Â¶ÇÂΩìÂâçÊó•ÊúüÂåπÈÖçÂà∞ËÆ¢ÈòÖÔºåÂàôÂèëÈÄÅÈÄöÁü•
        text = ""
        for sub in current_tv_subscribe:
            text += sub.get("name") + " "
            text += sub.get("season") + " " + sub.get("episode")
            text += "\n"

        for sub in current_movie_subscribe:
            text += sub.get("name")
            text += "\n"

        if text:
            self.post_message(mtype=NotificationType.Subscribe,
                              title=f"‰ªäÂ§©ÂâßÈõÜÊõ¥Êñ∞ ÂÖ± {len(current_tv_subscribe) + len(current_movie_subscribe)} ÈÉ®",
                              image=img_url,
                              text=text)

    def get_state(self) -> bool:
        return self._enabled

    @staticmethod
    def get_command() -> List[Dict[str, Any]]:
        pass

    def get_api(self) -> List[Dict[str, Any]]:
        pass

    def get_form(self) -> Tuple[List[dict], Dict[str, Any]]:
        """
        ÊãºË£ÖÊèí‰ª∂ÈÖçÁΩÆÈ°µÈù¢ÔºåÈúÄË¶ÅËøîÂõû‰∏§ÂùóÊï∞ÊçÆÔºö1„ÄÅÈ°µÈù¢ÈÖçÁΩÆÔºõ2„ÄÅÊï∞ÊçÆÁªìÊûÑ
        """
        return [
            {
                'component': 'VForm',
                'content': [
                    {
                        'component': 'VRow',
                        'content': [
                            {
                                'component': 'VCol',
                                'props': {
                                    'cols': 12,
                                    'md': 6
                                },
                                'content': [
                                    {
                                        'component': 'VSwitch',
                                        'props': {
                                            'model': 'enabled',
                                            'label': 'ÂêØÁî®Êèí‰ª∂',
                                        }
                                    }
                                ]
                            },
                            {
                                'component': 'VCol',
                                'props': {
                                    'cols': 12,
                                    'md': 6
                                },
                                'content': [
                                    {
                                        'component': 'VSwitch',
                                        'props': {
                                            'model': 'onlyonce',
                                            'label': 'Á´ãÂç≥ËøêË°å‰∏ÄÊ¨°',
                                        }
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        'component': 'VRow',
                        'content': [
                            {
                                'component': 'VCol',
                                'props': {
                                    'cols': 12,
                                },
                                'content': [
                                    {
                                        'component': 'VTextField',
                                        'props': {
                                            'model': 'time',
                                            'label': 'Êó∂Èó¥',
                                            'placeholder': 'ÈªòËÆ§9ÁÇπ'
                                        }
                                    }
                                ]
                            },
                        ]
                    },
                    {
                        'component': 'VRow',
                        'content': [
                            {
                                'component': 'VCol',
                                'props': {
                                    'cols': 12,
                                },
                                'content': [
                                    {
                                        'component': 'VTextarea',
                                        'props': {
                                            'model': 'img_link',
                                            'label': 'Â§¥Âõæ',
                                            'placeholder': 'Â§¥ÂõæÈÖçÁΩÆËØ∑Áî®,ÂàÜÂâ≤ÔºåÊØèÊ¨°ÈöèÊú∫Âèñ‰∏Ä‰∏™,Âú∞ÂùÄ‰ª•httpÂºÄÂßã'
                                        }
                                    }
                                ]
                            },
                        ]
                    },
                    {
                        'component': 'VRow',
                        'content': [
                            {
                                'component': 'VCol',
                                'props': {
                                    'cols': 12,
                                },
                                'content': [
                                    {
                                        'component': 'VAlert',
                                        'props': {
                                            'type': 'info',
                                            'variant': 'tonal',
                                            'text': 'ÈªòËÆ§ÊØèÂ§©9ÁÇπÊé®ÈÄÅÔºåÈúÄÂºÄÂêØÔºàËÆ¢ÈòÖÔºâÈÄöÁü•Á±ªÂûã„ÄÇ'
                                        }
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        'component': 'VRow',
                        'content': [
                            {
                                'component': 'VCol',
                                'props': {
                                    'cols': 12,
                                },
                                'content': [
                                    {
                                        'component': 'VAlert',
                                        'props': {
                                            'type': 'info',
                                            'variant': 'tonal',
                                            'text': 'ÂõæÁâáÈÖçÁΩÆËØ¥Êòé'
                                                    'Â¶ÇÊûú‰∏çÈÖçÁΩÆÂõæÁâáÂàóË°®ÔºåÂàô‰ºöÂèñÊâÄÊúâÁöÑ backdrop ÊàñËÄÖ poster ÂéªÂÅöÂ§¥ÂõæÔºåÂ¶ÇÊûúÂèñ‰∏çÂà∞ÂàôÂèñÈªòËÆ§'
                                                    'Â§¥ÂõæËØ∑Áî®,ÂàÜÂâ≤ÔºåÂèØ‰ª•ËÆæÁΩÆÂ§ö‰∏™Ôºå‰ºöÈöèÊú∫‰∏Ä‰∏™'
                                        }
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        ], {
            "enabled": False,
            "onlyonce": False,
            "time": 9,
        }

    def get_page(self) -> List[dict]:
        pass

    def stop_service(self):
        """
        ÈÄÄÂá∫Êèí‰ª∂
        """
        try:
            if self._scheduler:
                self._scheduler.remove_all_jobs()
                if self._scheduler.running:
                    self._scheduler.shutdown()
                self._scheduler = None
        except Exception as e:
            logger.error("ÈÄÄÂá∫Êèí‰ª∂Â§±Ë¥•Ôºö%s" % str(e))
